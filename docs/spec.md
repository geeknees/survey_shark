# SurveyShark — AIインタビュー型アンケート（MVP v1）完全仕様書

最終更新: 2025-08-02 / タイムゾーン: Asia/Tokyo

---

## 0. 目的と背景

* **目的**: 中高生（および保護者）に対して、定型設問では拾いづらい“学習上のペイン”を\*\*AIインタビュー（チャット）\*\*で発見し、

  * ダッシュボードで **Painランキング** と **インサイトカード** を提示する。
* **MVPのフォーカス**: 課題発見（JTBDの“ペイン側”）に特化。
* **利用形態**: 単一テナント / 各ユーザーは Kamal で **自前デプロイ**。DBは **SQLite（WAL）**、ジョブは **Solid Queue**、LLMは **OpenAI** を使用。

---

## 1. 対象ユーザー / 回答者セグメント

* **初期対象**: 中高生。
* 二次対象: 小学生/中学生の学習に関する保護者（代理回答）。
* **リンクは共通**（学生/保護者で分けない）。回答中に属性で区別しない（LLM推定のみ、保存なし）。

---

## 2. 成果物（アウトプット）

* **Painランキング（冒頭に上位5件）**

  * 並び順: **頻度優先**（会話単位降順 → 発言単位で同率ブレーク）。
  * 尺度: 頻度（会話単位=主指標／発言単位=補助指標）と **深刻度（自動推定）**。
* **インサイトカード**（1テーマ=1枚）

  * 項目: テーマ名 / 代表引用（最大2）/ 深刻度(1–5) / 発生頻度（会話/発言）/ **確信度（L/M/H）**。
  * **確信度スコア** = 0.7×正規化頻度 + 0.3×代表引用数。閾値: L<40, M=40–69, H≥70。

---

## 3. KPI（ダッシュボード冒頭・固定表示）

1. **総回答数 / 上限 / 残り枠**
2. **強いペイン出現率**（深刻度 **4以上** を含む会話の割合）
3. **平均ターン数**（回答者の発話回数）

---

## 4. ユーザーフロー（回答者）

**ステート確定（MVP v1）**

1. 同意（開始ボタン=同意）
2. 属性入力（**年齢=整数・任意 / 0–120**、＋任意のカスタム属性 ※短文テキスト）
3. ペイン列挙（最大3件）
4. 深掘り対象の選択（**AIが推奨**=深刻度優先→回答者が選択確定）
5. 深掘り（1トピックにつき **最大2回**）
6. 要約確認（**ON** / 「合っていない」＝**自由記述1欄**のみ）
7. 送信完了（サンクスメッセージ / 「もう一度回答する」ボタンあり）

**補足**

* **進捗表示**: 残りターン数 + 進捗バー（両方）。
* **最大ターン数**: プロジェクトで設定可、**初期値12**。**スキップ**もカウントする。
* **入力制約**: 回答1ターン最大 **500文字**、空回答禁止（スキップあり）。AI応答は最大 **400文字**。
* **回答スタイル**: テキスト + クイックリプライ。

  * 常設: 「**質問を言い換えて**」。
  * 動的（最大3件/ターン）: ホワイトリストから選択
    （1 具体例を挙げる / 3 もう少し詳しく / 4 わからない / 7 それは違うかも / 2 別の理由 / 8 他の選択肢は？）。
* **タイムアウト**: なし（無操作でもセッション失効なし）。
* **再開機能**: なし（離脱は破棄）。

---

## 5. 同意画面 / 注意文

* **開始=同意**（チェックなし）。
* **必ず表示する文言（デフォルト）**

  1. 調査目的: 「課題調査のアンケートにご協力お願いいたします。」
  2. 所要時間: 「5〜10分」
  3. 個人情報の禁止: 「氏名、住所、連絡先などの個人情報は入力しないでください。」

---

## 6. 招待リンク / 回答上限 / スパム対策

* **リンク方式**: **共通リンク（再利用可）**。
* **上限**: プロジェクト単位の **総回答数上限=初期50**（**開始時点でカウント**）。
* **有効期限**: 期限なし。
* **同一ブラウザからの複数回答**: 許可。
* **CAPTCHA/レート制限**: なし。
* **Closed時表示**: 「募集は終了しました。ご協力ありがとうございました。」（固定文言）。

---

## 7. 管理UI（必須画面）

1. **プロジェクト一覧/新規作成/編集**
2. **会話ログの全文ビュー**（1対話の通し確認）
3. **進捗ダッシュボード**（KPI固定3点）
4. **インサイトボード**（Painランキング/カード一覧）
5. **管理者アカウント設定**（パスワード変更のみ）

**プロジェクト作成フォーム（必須項目）**

* ① プロジェクト名（タイトル）
* ② 調査目的（短文）
* ③ インタビューガイド（Must-Ask 0–5件）
* ④ 禁則（Never-Ask）
* ⑤ トーン（**やさしい敬語**）
* ⑥ 最大ターン上限（初期12）
* ⑦ 総回答数上限（初期50）
* ⑧ 属性収集設定（年齢: 整数/任意/0–120、＋**カスタム属性**: テキスト短文のみ）

**設定方針**

* Active中も**全面変更可**（保存後は新規会話に即反映。進行中会話は影響なし）。
* プロジェクト状態: **Draft / Active / Closed**（上限到達で自動Closed）。

---

## 8. インタビュー生成（LLM）

* **モデル**: OpenAI **gpt-4.1**（品質重視）
* **温度**: **0.2**（安定重視）
* **APIキー**: **環境変数のみ**（`OPENAI_API_KEY`）
* **ストリーミング**: **Turbo Streams(SSE)** でフロントへ逐次表示
* **応答制約**: 1ターン最大 **400文字**（超過時は要点で要約）
* **クイックリプライ**: 上記ホワイトリストから最大3件を文脈で選択

**システムプロンプト（必須ルール）**

* 誘導禁止 / 1ターン1問 / **深掘り2回**
* **曖昧・抽象は言い換えて確認**（例・頻度・影響を具体化）
* **やさしい敬語**
* **最大12ターン** 厳守（スキップ含む）
* **クイックリプライ**: 常設「質問を言い換えて」＋動的最大3
* **PIIは検知したら自動マスク**（後述仕様）
* **終了前の要約確認**（Yes/No、No時は自由記述欄）

**既定フロー（ペイン深掘り特化）**

* 【列挙】最近直面した課題や不便と、その具体的な場面を教えてください。
* 【選択】先ほど挙げられた中から、最も重要だと思う1件を選び、その理由を一言で教えてください。
* 【具体】今思っていることを書いてください。
* ※ LLM障害時: 上記**3問で終了**／**要約確認はスキップ**。

---

## 9. 解析パイプライン（Rubyのみ / MVP）

* **正規化**: 全角半角・記号・絵文字の正規化
* **トークン化**: `tiny_segmenter`（純Ruby）
* **ストップワード**: 独自リスト（助詞・助動詞等）
* **キーフレーズ**: RAKE（`rake_text` 等）+ シンプルTextRank（任意）
* **テーマ命名/要約**: LLM（gpt-4.1）
* **深刻度**: 否定/強調語のヒューリスティック + LLM再評価（自動）
* **頻度**: 会話単位（主）/ 発言単位（補）
* **確信度**: 0.7×頻度 + 0.3×引用数（正規化）。**クラスタ純度はMVPでは未使用**。
* **起動タイミング**: **会話完了後に一括**。再集計ボタンはMVPなし。

---

## 10. PII対策（氏名・連絡先 等）

* **検知方式**: **LLM判定のみ**（ルール併用なし）
* **LLM送出前**: **生データを送出**（保存時にマスク）。
* **UI表示**: **一旦原文を表示 → LLM判定後に即マスク**（一瞬見える可能性あり）。
* **マスク後の動作**: 続行（保存はマスク後）。
* **注意メッセージ（固定）**:

  > 個人情報が含まれていた可能性があるため一部を［氏名］などに置き換えました。内容に問題がなければ続行してください。
* **ログ**: **マスク後の本文のみ**を出力。

> 備考: 将来はルール併用や即時ブロックに切り替え可能な設計（LLMガード層の差し替え）。

---

## 11. 非機能要件 / SLO

* **レイテンシ目標**: 初トークン ≤ **3秒**、1ターン ≤ **10秒**。
* **スケール目標**: 同時セッション **10**、1日回答 **50**。
* **可用性/復旧**: LLMエラー時は **自動1回リトライ → 失敗時テンプレ3問** に切替。
* **言語**: 回答者UIは **日本語のみ**（i18n準備済）。
* **ブラウザ/端末**: **スマホ最優先**（iOS Safari 15+ / Android Chrome 100+） + PCは最新Chrome/Edgeで基本動作。

---

## 12. セキュリティ / プライバシ / 保存

* **データ保存期間**: **無期限**（手動削除のみ）。
* **削除単位**: **プロジェクト単位**の一括削除（ハードデリート）。
* **保存暗号化**: なし（平文）
* **収集メタ**: **IPアドレス / User-Agent** を会話メタに保存。
* **Never-Ask（常時NG）**: 5) 支払い情報/パスワード, 6) 第三者の個人情報

---

## 13. アーキテクチャ / 技術選定

* **サーバ**: Rails 8 / Rubyのみ解析（MeCab等はM1以降）
* **フロント**: Hotwire（Turbo / Stimulus）+ **Tailwind CSS**
* **DB**: SQLite（WAL）
* **ジョブ**: Solid Queue（Active Job）
* **ストリーミング**: Turbo Streams (SSE)
* **認証（管理）**: `bin/rails generate authentication`（**単一管理者**）
* **デプロイ**: **Kamal + Let’s Encrypt**（自動TLS）
* **監視/通知**: 外部エラー追跡なし / 通知なし（ログのみ）

---

## 14. データモデル（MVP最小）

※ SQLiteの `json` は実体TEXT。必要に応じてアプリ層でJSON化。

### projects

* id, name (string, not null)
* goal (text)
* must\_ask (json, default: \[])
* never\_ask (json, default: \[])
* tone (string, default: "polite\_soft")
* limits (json, default: { max\_turns: 12, max\_deep: 2 })
* status (string: draft/active/closed)
* max\_responses (integer, default: 50)
* created\_at, updated\_at

### invite\_links

* id, project\_id (fk)
* token (string, unique, not null)
* expires\_at (datetime, nullable)
* reusable (boolean, default: true) ※MVPは常にtrue
* created\_at, updated\_at

### participants

* id, project\_id (fk)
* anon\_hash (string, index)
* age (integer, nullable) ※任意
* attributes (json, default: {}) ※カスタム属性（短文）
* created\_at, updated\_at

### conversations

* id, project\_id (fk)
* participant\_id (fk, nullable)
* state (string, default: "intro")
* started\_at, finished\_at
* ip (string), user\_agent (text)
* created\_at, updated\_at

### messages

* id, conversation\_id (fk)
* role (integer: 0=user, 1=assistant, 2=system)
* content (text, not null) ※保存は**完成後に1件**
* meta (json, default: {}) ※LLMメタはMVPでは保存しない方針
* created\_at, updated\_at

### insight\_cards

* id, project\_id (fk)
* conversation\_id (fk, nullable)
* theme (string)
* jtbds (text, nullable)
* evidence (json, default: \[]) ※\[{quote: "...", message\_id: n}]
* severity (integer) ※1–5
* freq\_conversations (integer)
* freq\_messages (integer)
* confidence\_label (string: L/M/H)
* created\_at, updated\_at

---

## 15. ルーティング（管理/回答）

* 管理

  * `GET /projects`（一覧・新規）
  * `POST /projects` / `PATCH /projects/:id` / `DELETE /projects/:id`
  * `GET /projects/:id`（ダッシュボード）
  * `GET /projects/:id/insights`（インサイトボード）
  * `GET /projects/:id/conversations/:cid`（全文ビュー）
  * `POST /projects/:id/links`（共通リンク発行）
  * `PATCH /projects/:id/status`（Draft/Active/Closed）
* 回答

  * `GET /i/:token`（同意→属性→チャット開始）
  * チャット送受信: Turbo Streams（SSE）

> 再開用 `/c/:uuid` は **MVPから削除**。

---

## 16. ビヘイビア仕様（主要）

* **Must-Ask**: 上限5件。未設定でも開始可。会話中に織り込み（未消化は終盤で補う）。
* **Never-Ask**: 常時NG（PII関連等）。
* **回答修正**: 送信前の編集は不可（言い直しは会話内で）。
* **言語**: 日本語のみ。やさしい敬語で中立。
* **オンボーディング文**: なし（価値提示は表示しない）。

---

## 17. エラーハンドリング

* **LLM**: 自動1回リトライ → 失敗で固定テンプレ（3問）に切替（要約確認はスキップ）。
* **送信失敗**: リトライ案内。重複送信はサーバ側で二重登録防止。
* **上限到達/Closed**: 固定文言を表示し開始不可。

---

## 18. デプロイ / 運用

* **Kamal + Let’s Encrypt**（自動TLS）。
* **プロセス**: web(Puma) / worker(Solid Queue)。
* **DB**: SQLite（WAL, `busy_timeout=5000ms`）。
* **SSE**: ActionController::Live / Turbo Streams。
* **環境変数**

  * `OPENAI_API_KEY`（必須）
  * （任意）`PORT` / `RAILS_ENV=production`
* **管理者作成**: `bin/rails generate authentication`。管理者は**単一**。

  * 初期作成/リセット: `bin/rails admin:setup`（パスワード変更のみUI）。

---

## 19. 初期データ（seed）

* **サンプルプロジェクト** 1件

  * 状態: Draft
  * 上限: 10
  * 固定テンプレ3問プリセット / 年齢属性ON

---

## 20. 受け入れテスト（抜粋）

1. **起動/同意**: 同意画面3文言が表示され、開始でチャットへ遷移。
2. **属性**: 年齢の整数任意入力（0–120）。未入力でも開始可。空文字は許容。
3. **列挙/選択/深掘り**: 3件列挙→AI推奨→ユーザー選択→深掘り2回上限。
4. **クイックリプライ**: 常設「質問を言い換えて」+ 動的最大3が適切に提示。
5. **スキップ**: 押下で次へ。ターン数にカウント。
6. **要約確認**: Yes→送信 / No→自由記述1欄→送信。
7. **PII検知**: 原文表示→数秒でマスクに置換。保存・ログはマスク済み。
8. **上限**: 開始時カウント。上限到達でClosedに自動遷移、固定文言表示。
9. **ダッシュボード**: KPI3種が表示。Painランキングは頻度優先で上位5件。
10. **削除**: プロジェクト削除で関連データがハードデリート。

---

## 21. スコープ外（MVPでは非対応）

* エクスポート（CSV/Markdown）
* 読み取り専用共有リンク
* 期間フィルタ、再集計ボタン
* 監査ログ、通知（メール/Slack）
* Embeddings/クラスタリング、MeCab等の外部形態素解析
* CAPTCHA/レート制限
* エラー追跡（Sentry等）
* 再開機能、ローカル自動保存

---

## 22. ロードマップ（M1以降の候補・参考）

* Embeddings導入（OpenAI）/ sqlite-vss or pgvector への移行
* 期間フィルタ、再集計、エクスポート
* 監査ログ、通知（Slack/メール）、コスト上限
* ルール併用のPII即時マスク、CAPTCHA
* 多言語UI（英語切替）

---

## 23. 実装タスクリスト（M0スプリント）

1. Rails 8 プロジェクト雛形 / Tailwind / Turbo導入
2. 認証生成（単一管理者）& `bin/rails admin:setup`
3. モデル/マイグレーション（§14）
4. 管理UI: プロジェクトCRUD + 招待リンク + 状態切替
5. 回答導線 `/i/:token`（同意→属性→チャット）
6. SSEストリーミング / LLMクライアント（OpenAI; gpt-4.1; 温度0.2）
7. 解析ジョブ（会話完了時）+ インサイト生成
8. ダッシュボード/KPI + インサイトボード/カード
9. 会話全文ビュー
10. PII検知（LLM）→ 遅延マスク反映 / ログはマスク後
11. 上限管理（開始時カウント）/ Closed表示
12. seed: サンプルプロジェクト
13. 受け入れテスト（§20）

---

