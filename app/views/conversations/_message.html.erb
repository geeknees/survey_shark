<div id="message_<%= message.id %>" class="<%= message.user? ? 'flex justify-end' : 'flex justify-start' %>">
  <div class="<%= message.user? ? 'bg-blue-500 text-white ml-12' : 'bg-gray-100 text-gray-900 mr-12' %>
              rounded-lg px-4 py-2 max-w-prose">
    <div class="whitespace-pre-wrap"><%= message.content %></div>
    <% debug_enabled = (ENV["INTERVIEW_DEBUG"].to_s == "true") || (message.conversation&.meta&.dig("debug_mode") == true) %>
    <% if debug_enabled && !message.user? && (debug = message.meta&.dig("debug")) %>
      <div class="text-xs text-gray-500 mt-1">
        debug: 質問 <%= debug["user_turn_count"].to_i %>/<%= debug["max_turns"].to_i %> ・ 深掘り <%= debug["deepening_turn_count"].to_i %>/<%= debug["max_deep"].to_i %> ・ state <%= debug["state"].to_s %>
      </div>
    <% end %>
    <div class="text-xs opacity-70 mt-1">
      <%= message.created_at.strftime("%H:%M") %>
      <% if message.meta&.dig("pii_detected") %>
        <span class="ml-2 text-yellow-600">🔒 個人情報をマスクしました</span>
      <% end %>
    </div>
  </div>
</div>